---
title: "Group Project 4 COVID"
author: 'covid_p11'
date: '2022-03-28'
output:
  html_document:
    toc: true
    number_sections: true
    theme: flatly
    highlight: tango
    toc_float: true
    toc_depth: 4
    code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(maps)
library(plotly)
library(caret)
library(dplyr)
library(lubridate)
library("scales")
library("magrittr")
library("tidyr")
library(pkr)
```

Topic: COVID-19 New cases
visualisation dashboard: Shiny app

# NEW FINAL JOIN CODE BY MAXIM

```{r}
##########################
# THIS IS THE FINAL JOIN #
#######################################################################
# use covid_joined for your work and filter it to country if you need #
#######################################################################

covid = read.csv("owid-covid-data.csv")
sp500 = read.csv("SPY Historical Data.csv", fileEncoding = 'UTF-8-BOM') # This is for US
TOPIX = read.csv("TOPIX Historical Data.csv", fileEncoding = 'UTF-8-BOM') # This is for Japan
ASX200 = read.csv("S&P_ASX 200 Historical Data.csv", fileEncoding = 'UTF-8-BOM') # This is for Australia
NSEI = read.csv("Nifty 50 Historical Data.csv", fileEncoding = 'UTF-8-BOM') # This is for India
SSEC = read.csv("Shanghai Composite Historical Data.csv", fileEncoding = 'UTF-8-BOM') # this is for China

covid2 <- covid

covid2$date = as.character(ymd(covid2$date))
sp500$Date <- as.character(mdy(sp500$Date))
TOPIX$Date <- as.character(mdy(TOPIX$Date))
ASX200$Date <- as.character(mdy(ASX200$Date))
NSEI$Date <- as.character(mdy(NSEI$Date))
SSEC$Date <- as.character(mdy(SSEC$Date))

colnames(covid2)[4] = "Date"

covid_US <- covid2 %>% filter(location == "United States")
covid_AUS <- covid2 %>% filter(location == "Australia")
covid_IND <- covid2 %>% filter(location == "India")
covid_JPN <- covid2 %>% filter(location == "Japan")
covid_CHN <- covid2 %>% filter(location == "China")

df_1 = inner_join(sp500, covid_US, by = "Date")
df_2 = inner_join(TOPIX, covid_JPN, by = "Date")
df_3 = inner_join(ASX200, covid_AUS, by = "Date")
df_4 = inner_join(NSEI, covid_IND, by = "Date")
df_5 = inner_join(SSEC, covid_CHN, by = "Date")

covid_joined <- rbind(df_1, df_2, df_3, df_4, df_5)

covid_joined$Date <- ymd(covid_joined$Date)
covid_joined$Price <- as.numeric(gsub(",","",covid_joined$Price))
covid_joined$Open <- as.numeric(gsub(",","",covid_joined$Open))
covid_joined$High <- as.numeric(gsub(",","",covid_joined$High))
covid_joined$Low <- as.numeric(gsub(",","",covid_joined$Low))
covid_joined$Change.. <- as.numeric(gsub("%","",covid_joined$Change..))

# example analysis for US
US_data = covid_joined[covid_joined$location == "United States",]
plot(US_data$Price ~ US_data$Date)
```

# Question 1 - intial data visualisation

# First visualisation - visualising distribution of gains and losses amoung different years (is it ok to use plotly?)

```{r}
covid_joined <- covid_joined %>% 
  filter(Date >= "2020-03-11") %>%
  mutate(Year_category = case_when( 
    Date >= "2020-03-11" & Date < "2021-01-01" ~ "1st year", 
    Date >= "2021-01-01" & Date < "2022-01-01" ~ "2nd year", 
    Date >= "2022-01-01" & Date < "2023-01-01" ~ "3rd year (ongoing)"))

install.packages("ggthemes")
library(ggthemes)
ggplot(covid_joined, aes(x=Change.., y = location, fill = Year_category)) + geom_boxplot(outlier.colour="black",
             outlier.size=0.3, notch=TRUE) + theme_clean() + labs(y = "country", x = "Distribution of daily gains/losses (%)") + ggtitle("Distrubtion of daily gains/losses during the years of the pandemic")
```

# evolution of countries through the pandemic

```{r}
head(covid_joined)

ggplot

covid_joined %>% 
  filter(continent=="Oceania") %>% 
  ggplot(aes(gdpPercap, lifeExp, size=pop, colour = country)) +
  geom_point(alpha = 0.5, show.legend = TRUE) +
  scale_size(range = c(2,12)) +
  # Here comes the gganimate specific bits
  labs(title = 'Year: {frame_time}', x = 'GDP per capita in USD', y = 'Life Expectancy') +
  transition_time(year) +
  shadow_wake(.3)+
  ease_aes('linear')
```


# CLEANING AND (OLD JOIN CODE) (not going to use but will leave it because i think some of the code currently depends on it, will fix in the meeting together)

```{r}
covid = read.csv("owid-covid-data.csv")
ASX200 = read.csv("S&P_ASX 200 Historical Data.csv", fileEncoding = 'UTF-8-BOM') # This is for Australia
```

# data clean

```{r, eval=FALSE}
#Dropping NA
covid_clean = covid %>% drop_na(new_cases, new_cases_smoothed, new_vaccinations, new_vaccinations_smoothed, new_vaccinations_smoothed_per_million, population, population_density, median_age, extreme_poverty, total_vaccinations, hospital_beds_per_thousand, human_development_index, new_deaths, new_tests, weekly_icu_admissions_per_million, weekly_icu_admissions)

#This code changes the negative case values in the data set to zero
covid_clean$new_cases[covid_clean$new_cases < 0] <- 0
```

```{r}
#Dropping NA
covid_AUS <- covid %>% filter(location == "Australia")
covid_clean_AUS = covid_AUS %>% drop_na(new_cases, new_cases_smoothed, new_vaccinations, new_vaccinations_smoothed, new_vaccinations_smoothed_per_million, population, population_density, median_age, extreme_poverty, total_vaccinations, hospital_beds_per_thousand, human_development_index, new_deaths, new_tests, total_tests, total_cases)

#This code changes the negative case values in the data set to zero
covid_clean_AUS$new_cases[covid_clean_AUS$new_cases < 0] <- 0

#glimpse(covid_clean)
#covid_clean$date = as.Date(covid_clean$date)
#max(covid_clean$date)
#unique(covid_clean$location)
```

# the old join

```{r}
covid2 <- covid_clean_AUS

ASX200$date = mdy(ASX200$Date)

covid2$date = ymd(covid2$date)

covid2 <- covid2 %>%
  transform(covid2, date = as.character(date)) %>% 
  select(date, new_cases, new_deaths, location, new_vaccinations, new_tests, population, population_density, total_tests, total_vaccinations, total_cases)

ASX200$date <- as.character(ASX200$date)

ASX200$date <- as.character(ASX200$date)

covid_AUS <- covid2 %>% filter(location == "Australia")

df_3 = inner_join(ASX200, covid_AUS, by = "date")

df_3 = inner_join(ASX200, covid_AUS, by = "date")

df_aus <- df_3

df_aus$date = as.Date(df_aus$date)

df_aus$Price = as.numeric(gsub(",","",df_aus$Price))
```

# Q2 a

```{r}
df_aus = df_aus[order(as.Date(df_aus$date, format="%d/%m/%Y")),]

colnames(df_aus)[7] = 'Change'

#write.csv(df_aus,"df_aus.csv")
```

## Price ~ new_cases

```{r, warning=FALSE}
#glimpse(df_aus)
df_aus_subset = df_aus %>% select(Price, new_cases)

M0 = lm(Price ~ new_cases, data = df_aus_subset) # Null model
summary(M0)
```

## Price ~ new_vaccinations

```{r}
# df_aus_subset = df_aus %>% select(Price, new_deaths) %>% filter(new_deaths != 0)
```

## New deaths and prices 

```{r}
df_aus_subset = df_aus %>% select(Price, new_deaths, new_vaccinations, new_cases)

M1 = lm(Price ~ poly(new_vaccinations, degree=2), data=df_aus_subset)
summary(M1)
```

```{r}
ggplot(data = df_aus_subset, mapping = aes(x = Price, y = new_deaths)) + geom_point() + ggtitle("Prices of stocks and against new death") + ylab("New deaths") + xlab("Price")
```

## Price ~ new_vaccinations

```{r}
ggplot(data = df_aus, mapping = aes(x = new_vaccinations, y = Price)) + geom_point() + ggtitle("Prices of stocks against new vaccinations") + xlab("New vaccinations") + ylab("Price")
```

## Price ~ New tests

```{r}
df_aus_subset = df_aus %>% select(Price, new_tests)
M2 = lm(Price ~ poly(new_tests, degree=2), data=df_aus_subset)
summary(M2)
```

```{r}
df_aus_subset$Price <- log(df_aus_subset$Price/lag(df_aus_subset$Price))
df_aus_subset$new_tests <- log(df_aus_subset$new_test)
ggplot(data = df_aus_subset, mapping = aes(x = new_tests, y = Price)) + geom_point() + ggtitle("Prices of stocks against new tests") + xlab("New tests") + ylab("Price")
```

```{r, eval=FALSE}
ggplot(data = df_aus, mapping = aes(x = Price, y = population)) + geom_point() + ggtitle("Prices of stocks against population") + ylab("New tests") + xlab("Price")
ggplot(data = df_aus, mapping = aes(x = Price, y = population_density)) + geom_point() + ggtitle("Prices of stocks against population density") + ylab("New tests") + xlab("Price")
ggplot(data = df_aus, mapping = aes(x = date, y = population_density)) + geom_line() + ggtitle("Prices of stocks against population density") + ylab("New tests") + xlab("Price") # bad
summary(df_aus$Price)
```

```{r}
df_aus$Price_mul30 = df_aus$Price*30
p1 = ggplot(data = df_aus) + geom_line(aes(x=date, y = new_cases), color = "red") + geom_line(aes(x=date, y = new_vaccinations), color = "light green") + geom_line(aes(x=date, y = new_tests), color = "light blue") +
  geom_line(aes(x=date, y = Price_mul30), color = "blue") + theme_bw()

df_aus$Price_mul30 = df_aus$Price*30
p1 = ggplot(data = df_aus) + geom_line(aes(x=date, y = new_cases), color = "red") + geom_line(aes(x=date, y = new_vaccinations), color = "light green") + geom_line(aes(x=date, y = new_tests), color = "light blue")+ theme_bw()
ggplotly(p1)
```


```{r, eval=FALSE}
#autoplot(M0, which = 1:2)
#autoplot(M1, which = 1:2)
#autoplot(M2, which = 1:2)
```

```{r}
M = lm(Price ~ polym(new_tests, new_vaccinations, degree=2, raw=TRUE), data=df_aus)
summary(M)
ggplot(data = df_aus) + geom_point(aes(x = new_tests, y = Price), color = "light blue") +
  geom_point(aes(x = new_vaccinations, y = Price), color = "light green") +
  ggtitle("Prices of stocks against new tests and new_vaccinations") + ylab("Price") +theme_classic()
```

- The behaviour of a dependent variable is explained by a linear, or curvilinear, additive relationship between the dependent variable and a set of k independent variables (xi, i=1 to k).
- The relationship between the dependent variable and any independent variable is linear or curvilinear.
- The independent variables do no depend on each other too.
- The errors are independent, normally distributed with mean zero and a constant variance.

## Log Price vs grwth rate (give up) 

### Calculate grwth rate

```{r, eval=FALSE}
covid_clean_AUS <- df_aus
percentage_tests <- (covid_clean_AUS$new_tests/ covid_clean_AUS$total_tests)*100
vec_percentage_tests <- c(percentage_tests)
covid_clean_AUS <-cbind(covid_clean_AUS, perc_new_tests = vec_percentage_tests)

covid_clean_AUS <- covid_clean_AUS
percentage_cases <- (covid_clean_AUS$new_cases/ covid_clean_AUS$total_cases)*100
vec_percentage_cases <- c(percentage_cases)
covid_clean_AUS <-cbind(covid_clean_AUS, perc_new_cases = vec_percentage_cases)

covid_clean_AUS <- covid_clean_AUS
percentage_vacc <- (covid_clean_AUS$new_vaccinations/ covid_clean_AUS$total_vaccinations)*100
vec_percentage_vacc <- c(percentage_vacc)
covid_clean_AUS <-cbind(covid_clean_AUS, perc_new_vacc = vec_percentage_vacc)
df_aus_Q2 <- covid_clean_AUS

df_aus_Q2$lprice = log(df_aus_Q2$Price)
```

### Visulization

```{r, eval=FALSE}
ggplot(data = df_aus_Q2) + geom_point(aes(x = perc_new_tests, y = lprice), color = "light blue") +
  geom_point(aes(x = perc_new_vacc, y = lprice), color = "light green") +
  geom_point(aes(x = perc_new_cases, y = lprice), color = "red") +
  ggtitle("Prices of stocks againsts growth rate of new cases, new vaccinations and new tests") + xlab("growth rate") + ylab("log(Price)") +theme_classic()
```

Very bad plot....

```{r, eval=FALSE}
df_aus_Q2 = filter(df_aus_Q2, date >= "2021-03-05")

colors <- c("new vaccinations" = "light green", "new cases" = "red", "new tests" = "orange", "log price" = "black")
p1 = ggplot(data = df_aus_Q2, aes(x=date)) + geom_line(aes(y = perc_new_cases, color = "new cases")) + geom_line(aes(y = perc_new_vacc, color = "new vaccinations")) +
  geom_line(aes(y = lprice, color = "log price")) + 
  geom_line(aes(y = perc_new_tests, color = "new tests")) +
  labs(x = "Date",
         y = "(%)",
         color = "Legend") +
  scale_color_manual(values = colors) + theme_bw()
ggplotly(p1)
```

## Slope

```{r}
class(df_aus$date)
Slope(df_aus$date, df_aus$Price)
```

# Rolling correlation (part of question 2 done by maxim) BTW THIS CODE IS REALLY MESSY :)

```{r}
library(tseries)
library(quantmod)
library(roll)
library(plotly)

mySymbols <- c('AMZN', '^GSPC','NFLX','MSFT','GOOG','NVAX','DIS','WMT','COST','V','FB','AXP','CMCSA','PFE','MRNA')
myStocks <-lapply(mySymbols, function(x) {getSymbols(x, src = "yahoo", 
                                                     from = "2020-01-01", 
                                                     to = "2022-04-04",
                                                     periodicity = "daily",
                                                     auto.assign=FALSE)} )

closePrices <- lapply(myStocks, Cl)
closePrices <- as.data.frame(do.call(merge, closePrices))
closePrices <- na.omit(log(closePrices/lag(closePrices)))
closePrices <- rownames_to_column(closePrices, "Date")

date <- closePrices["Date"]
date

# will need to probably write a function for this later as at the moment i am just hard coding this

corr_AMZN <- as.data.frame(roll_cor(closePrices$AMZN.Close, closePrices$GSPC.Close, width = 150)) %>% cbind(date) %>% na.omit
corr_NFLX <- as.data.frame(roll_cor(closePrices$NFLX.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_MSFT <- as.data.frame(roll_cor(closePrices$MSFT.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_GOOG <- as.data.frame(roll_cor(closePrices$GOOG.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_NVAX <- as.data.frame(roll_cor(closePrices$NVAX.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_DIS <- as.data.frame(roll_cor(closePrices$DIS.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_WMT <- as.data.frame(roll_cor(closePrices$WMT.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_COST <- as.data.frame(roll_cor(closePrices$COST.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_V <- as.data.frame(roll_cor(closePrices$V.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_FB <- as.data.frame(roll_cor(closePrices$FB.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_AXP <- as.data.frame(roll_cor(closePrices$AXP.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_CMCSA <- as.data.frame(roll_cor(closePrices$CMCSA.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_PFE <- as.data.frame(roll_cor(closePrices$PFE.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit
corr_MRNA <- as.data.frame(roll_cor(closePrices$MRNA.Close, closePrices$GSPC.Close, width = 150))%>% cbind(date) %>% na.omit

corr_AMZN$symbol <- "AMZN"
corr_NFLX$symbol <- "NFLX"
corr_GOOG$symbol <- "GOOG"
corr_NVAX$symbol <- "NVAX"
corr_V$symbol <- "VISA"
corr_FB$symbol <- "FB"
corr_MSFT$symbol <- "MSFT"
corr_PFE$symbol <- "PFE"
corr_MRNA$symbol <- "MRNA"

colnames(corr_AMZN)[1] = "corr"
colnames(corr_NFLX)[1] = "corr"
colnames(corr_MSFT)[1] = "corr"
colnames(corr_GOOG)[1] = "corr"
colnames(corr_NVAX)[1] = "corr"
colnames(corr_DIS)[1] = "corr"
colnames(corr_WMT)[1] = "corr"
colnames(corr_COST)[1] = "corr"
colnames(corr_V)[1] = "corr"
colnames(corr_FB)[1] = "corr"
colnames(corr_AXP)[1] = "corr"
colnames(corr_CMCSA)[1] = "corr"
colnames(corr_PFE)[1] = "corr"
colnames(corr_MRNA)[1] = "corr"

corr_joined = rbind(corr_AMZN, corr_NFLX, corr_GOOG, corr_NVAX, corr_V, corr_FB, corr_MSFT, corr_PFE, corr_MRNA)

corr_joined$Date <- as.Date(corr_joined$Date)
corr_joined

library(ggthemes)
p = ggplot(corr_joined, aes(x=Date, y=corr, colour = symbol)) + geom_line() + labs(x = "Date", y = "rolling correlation (150D period)") + ggtitle("examining correlation of vaccine macufacturers compared to typical stocks") + theme_clean()

ggplotly(p)
```


