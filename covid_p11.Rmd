---
title: "Group Project 4 COVID"
author: 'covid_p11'
date: '2022-03-28'
output:
  html_document:
    toc: true
    number_sections: false
    theme: flatly
    highlight: tango
    toc_float: true
    toc_depth: 4
    code_folding: hide
---

# Topic
```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(maps)
library(plotly)
library(caret)
library(dplyr)
library(lubridate)
```

Question: Investigate the impact of COVID-19 on country specific public equity markets and the respective country economy.
1. Perform a geographical plot with visualizing changes in public equity and covid cases over a period of time (probably 2020-2022)
2. Is there a relationship between equity market recovery (going back to pre-covid prices) and vaccine rollout
is this the same for commodities?
is this the same for crypto?
3. Identify potential relationship between cases and stocks/ death and stocks
4. can build a ML model to predict stock market with covid-data. 

visualisation dashboard: Shiny app

stock market data set: https://www.marketwatch.com/investing/index/spx/download-data?startDate=1/1/2020&endDate=03/30/2022

```{r}
covid = read.csv("owid-covid-data.csv")

# these are indices for each country (an index is just a collection of stocks)
# 'FileEncoding' just cleans the column encoding for this case

sp500 = read.csv("SPY Historical Data.csv", fileEncoding = 'UTF-8-BOM') # This is for US
TOPIX = read.csv("TOPIX Historical Data.csv", fileEncoding = 'UTF-8-BOM') # This is for Japan
ASX200 = read.csv("S&P_ASX 200 Historical Data.csv", fileEncoding = 'UTF-8-BOM') # This is for Australia
NSEI = read.csv("Nifty 50 Historical Data.csv", fileEncoding = 'UTF-8-BOM') # This is for India
SSEC = read.csv("Shanghai Composite Historical Data.csv", fileEncoding = 'UTF-8-BOM') # this is for China

glimpse(covid)
```

# data clean
```{r}
#Dropping NA
covid_clean = covid %>% drop_na(new_cases, new_cases_smoothed, new_vaccinations, new_vaccinations_smoothed, new_vaccinations_smoothed_per_million, population, median_age, extreme_poverty, total_vaccinations, hospital_beds_per_thousand, human_development_index)

#This code changes the negative case values in the data set to zero
covid_clean$new_cases[covid_clean$new_cases < 0] <- 0


glimpse(covid_clean)
unique(covid_clean$location)
```

# performing join
```{r}
# using a copy just in case
covid2 <- covid_clean

sp500$Date = mdy(sp500$Date)
TOPIX$Date = mdy(TOPIX$Date)
ASX200$Date = mdy(ASX200$Date)
NSEI$Date = mdy(NSEI$Date)
SSEC$Date = mdy(SSEC$Date)
covid2$date = ymd(covid2$date)

#Temporarily changing the date to character as joining cannot be done with date objects
#Also selecting relevant columns for analysis later
covid2 <- covid2 %>%
  transform(covid2, date = as.character(date)) %>% 
  select(date, new_cases, new_deaths, location, new_vaccinations)
sp500$Date <- as.character(sp500$Date)
TOPIX$Date <- as.character(TOPIX$Date)
ASX200$Date <- as.character(ASX200$Date)
NSEI$Date <- as.character(NSEI$Date)
SSEC$Date <- as.character(SSEC$Date)

# renaming column so it has same name as the stock market data frames for joining later
colnames(covid2)[1] = "Date"

# making data frames for each country we select to perform individual joins on each to their respective stock market index
covid_US <- covid2 %>% filter(location == "United States")
covid_AUS <- covid2 %>% filter(location == "Australia")
covid_IND <- covid2 %>% filter(location == "India")
covid_JPN <- covid2 %>% filter(location == "Japan")
covid_CHN <- covid2 %>% filter(location == "China")

# performing joins 
df_1 = inner_join(sp500, covid_US, by = "Date")
df_2 = inner_join(TOPIX, covid_JPN, by = "Date")
df_3 = inner_join(ASX200, covid_AUS, by = "Date")
df_4 = inner_join(NSEI, covid_IND, by = "Date")
df_5 = inner_join(SSEC, covid_CHN, by = "Date")

# vertically joined data set (now one column will store all the values of the respective country index)
# e.g US stores prices relevant to S&P500 and China's prices are relevant to the the SSEC which is based in Shanghai.
covid_joined <- rbind(df_1, df_2, df_3, df_4, df_5)

# Still need transform relevant column to numeric ect...will do a little later 
```


# Initial analysis
## For new_cases_smoothed
```{r}
covid_temp <- covid_clean
covid_temp$month <- strftime(covid_temp$date, "%m")
covid_temp$year  <- strftime(covid_temp$date, "%Y")

covid_temp_new_case_aggregate <- aggregate(new_cases_smoothed~month+year, 
                  covid_temp,
                  FUN = mean)
covid_temp_new_case_aggregate$month_year <- paste(covid_temp_new_case_aggregate$month, covid_temp_new_case_aggregate$year)
```

```{r}
ggplot(covid_temp_new_case_aggregate, aes(x= new_cases_smoothed, y= month_year)) +
  geom_bar(stat = 'identity') + ggtitle("Average New Cases (Smoothed) per Month") +
  ylab("month year") + xlab("average new cases")
```

- Analysis: From the above bar plot, we set different months of 2021 and 2022 as y-axis and the average smoothed new cases for each month as x-axis. We can easily know that smoothed new cases in most months are less than 30,000 except in Jan, 2022, which is nearly 50,000. So the data of new_cases_smoothed is evenly distributed and has a small standard deviation.

## For new_people_vaccinated_smoothed
```{r}
covid_temp = covid_clean %>% select(date,new_people_vaccinated_smoothed)
covid_temp$date <- as.Date(covid_temp$date, format = "%Y-%m-%d")
covid_temp_new_vaccinated_aggregate = covid_temp %>% mutate(month_year = as.character(format(date, "%m-%Y"))) %>%
          group_by(month_year) %>%
  summarise(date=date[1], number = mean(new_people_vaccinated_smoothed))
covid_temp_new_vaccinated_aggregate  
```

```{r}
ggplot(covid_temp_new_vaccinated_aggregate, aes(x = number, y= month_year)) +
  geom_bar(stat = 'identity') + ggtitle("Average New People Vaccinated (Smoothed) per Month") +
  ylab("month year") + xlab("average new people vaccinated")
```

- Analysis: Most number show above are larger than 100000. Many people get vaccinated in July, August and September in 2021, and less people get vaccinated before and after that period which is reasonable since it takes time to invent and promote new vaccines.

# geographical plot

```{r}

```

